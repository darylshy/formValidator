<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Household builder</title>
        <style>
            .debug {
                font-family: monospace;
                border: 1px solid black;
                padding: 10px;
                display: none;
            }
            form>div{
              margin-bottom: 5px;
            }
            form>div>label{
                padding: 1px;
            }
            .invalid{
                border: 1px solid red;
            }
            .invalid>span{
                background-color: red;
                color: white;
                padding: 1px 5px;
                margin-right:-1px;
            }
        </style>
    </head>
    <body>
        <h1>Household builder</h1>
        <div class="builder">
            <ol class="household"></ol>
            <form>
                <div>
                    <label>Age
                        <input type="text" name="age">
                    </label>
                </div>
                <div>
                    <label>Relationship
                        <select name="rel">
                            <option value="">---</option>
                            <option value="self">Self</option>
                            <option value="spouse">Spouse</option>
                            <option value="child">Child</option>
                            <option value="parent">Parent</option>
                            <option value="grandparent">Grandparent</option>
                            <option value="other">Other</option>
                        </select>
                    </label>
                </div>
                <div>
                    <label>Smoker?
                        <input type="checkbox" name="smoker">
                    </label>
                </div>
                <div>
                    <button class="add">add</button>
                </div>
                <div>
                    <button type="submit">submit</button>
                </div>
            </form>
        </div>
        <pre class="debug"></pre>
        <script>
            (function(){
            //cached DOM elements and custom methods
                var DOM = {
                    body: document.querySelector('body'),
                };
                DOM.form = {
                    el: DOM.body.querySelector('form'),
                    formEls: DOM.body.querySelector('form').elements
                };

                DOM.age = {
                    el: DOM.form.el.querySelector('input[name="age"]'),
                    error: null,
                    message: "Invalid Age",
                    content: null
                };
                DOM.rel = {
                    el: DOM.form.el.querySelector('select[name="rel"]'),
                    error: null,
                    message: 'Relationship is Required',
                    content: null
                };
                DOM.smoker = {
                    el: DOM.form.el.querySelector('input[name="smoker"]'),
                    content: null
                };
                DOM.buttons = {
                    group: document.getElementsByTagName('button'),
                    add: DOM.form.el.querySelector('button.add'),
                    submit: DOM.form.el.querySelector('button[type="submit"]')
                };
                DOM.age.el.setAttribute('required', 'true');
                DOM.rel.el.setAttribute('required', 'true');
                //Helper methods
                DOM.addClass = function (className) {
                    var changeClass = this.getAttribute('class');
                    if(!changeClass){
                        this.setAttribute('class', className);
                    }else {
                        var rgx = new RegExp('' + className + '', 'gi');
                        if(changeClass.search(rgx)===-1){
                            changeClass += " " + className;
                            this.setAttribute('class', changeClass.trim());
                        }
                    }
                };

                DOM.removeClass = function (className) {
                    var changeClass = this.getAttribute('class');
                    var rgx = new RegExp('' + className + '', 'gi');
                    this.setAttribute('class', changeClass.replace(rgx, '').trim());

                    //check if class is empty
                    if(!this.getAttribute('class')){
                        this.removeAttribute('class');
                    }
                };

                DOM.disableButtons = function () {
                    for(var i = 0; i<DOM.buttons.group.length; i++){
                        DOM.buttons.group.item(i).disabled = true;
                    }
                };

                DOM.enableButtons = function () {
                    if(!DOM.age.error && !DOM.rel.error){
                        for(var i = 0; i<DOM.buttons.group.length; i++){
                            DOM.buttons.group.item(i).disabled = false;
                        }
                    }
                };

                DOM.form.setPristine =  function setPristine() {
                    var touched = new RegExp(/touched/,'gi');
                    var dirty = new RegExp(/dirty/,'gi');
                    var formElms = this.formEls;
                    for(var i = 0; i < formElms.length; i++){
                        if(formElms.item(i).getAttribute('class')){
                            if(formElms.item(i).getAttribute('class').search(touched) !== -1){
                                DOM.removeClass.call(formElms.item(i), 'touched');
                            }
                            if(formElms.item(i).getAttribute('class').search(dirty) !== -1){
                                DOM.removeClass.call(formElms.item(i), 'dirty');
                            }
                        }

                    }
                };

                DOM.form.touchEl = function(e) {
                    DOM.addClass.call(e.currentTarget,'touched');
                };

                DOM.form.dirtyEl = function(e){
                    DOM.addClass.call(e.currentTarget,'dirty');
                };

                DOM.form.reset = function() {
                    var els = this.formEls;
                    var val;
                    for(var i = 0; i<els.length; i++){
                        if(val = els.item(i).value){
                            if(val === 'on'){
                                els.item(i).checked = false;
                            }else{
                                els.item(i).value = '';
                            }
                        }
                    }
                    this.setPristine();
                };

                DOM.form.requiredMembers = function() {
                    var elements = [];
                    var formEls = this.formEls;
                    for(var i = 0; i<formEls.length; i++){
                        if(formEls.item(i).required === true){
                            elements.push(formEls.item(i));
                        }
                    }
                    return elements;
                };

                //Helper Functions
                function checkValueOf(target) {
                    if(target['name'] === 'age'){
                        return target.value === '' || !isInt(target.value) || target.value < 1;
                    }else{
                        return target.value === '';
                    }
                }
                
                function isInt(val) {
                    var rgx = new RegExp(/^\d+$/, 'g');
                    return rgx.test(val);
                }



                function isRequiredAndValid() {
                    var elements = DOM.form.requiredMembers();
                    var count = 0;
                    for(var i = 0; i<elements.length; i++){
                        if(/dirty/gi.test(elements[i].getAttribute('class'))){
                            count++;
                        }
                    }
                    return count === elements.length;
                }
                function triggerValidate() {
                    var elements = DOM.form.requiredMembers();
                    elements.forEach(function (el) {
                        el.focus();
                        el.blur();
                    });
                }

                function validate(e) {
                    var targetElement = DOM[e.currentTarget['name']];
                    if(checkValueOf(e.target)){
                        if (targetElement.error){
                            targetElement.error.remove();
                            targetElement.error = null;
                        }
                        targetElement.error = document.createElement('span');
                        targetElement.error.innerHTML = targetElement.message;
                        e.target.parentNode.appendChild(targetElement.error);
                        DOM.addClass.call(e.target.parentElement, 'invalid');//
                        DOM.disableButtons();
                    }else {
                        if (targetElement.error){
                            targetElement.error.remove();
                            targetElement.error = null;
                            DOM.removeClass.call(e.target.parentElement, 'invalid');
                            DOM.enableButtons();
                        }
                    }
                }

                //Member class instantiated on add
                function Member(age, rel, smoker) {
                    this.age = age;
                    this.rel = rel;
                    this.smoker = smoker;
                }

                var members = [];

                function create(age, rel, smoker) {
                    var member = new Member(age, rel, smoker);
                    members.push(member);
                }

                function read() {

                }

                function update() {

                }

                function dlete() {

                }

                //Events
                //textbox: age
                DOM.age.el.addEventListener('blur', validate, false);
                DOM.age.el.addEventListener('focus', DOM.form.touchEl, false);
                DOM.age.el.addEventListener('keyup', function(e) {
                    DOM.form.dirtyEl(e);
                    validate(e);
                    DOM.age.content = e.currentTarget.value;
                }, false);

                //dropdown: relationship
                DOM.rel.el.addEventListener('change', function(e){
                    validate(e);
                    DOM.form.dirtyEl(e);
                    DOM.rel.content = e.currentTarget.value;
                    //disableSelf();
                },false);
                DOM.rel.el.addEventListener('focus', DOM.form.touchEl, false);
                DOM.rel.el.addEventListener('blur',validate,false);

                //smoker
                DOM.smoker.el.addEventListener('change', function (e) {
                    DOM.smoker.content = e.currentTarget.checked;
                });

                DOM.buttons.add.onclick = function(e){
                    e.preventDefault();
                    if(!isRequiredAndValid()){
                        triggerValidate();
                    }else {
                        create(DOM.age.content,DOM.rel.content,DOM.smoker.content);
                        console.log(members);
                        DOM.form.reset();
                    }
                };

                DOM.buttons.submit.onclick = function (e) {
                    e.preventDefault();
                    DOM.form.setPristine();

                };
                
                
                

                
            })();
        </script>
    </body>
</html>
